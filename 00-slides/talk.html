<!DOCTYPE html>
<html>
<head>
  <title>Using R Packages, Version Control, and Continuous Integration to Build Reproducible Reports</title>

  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="generator" content="pandoc" />




  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <base target="_blank">

  <script type="text/javascript">
    var SLIDE_CONFIG = {
      // Slide settings
      settings: {
                title: 'Using R Packages, Version Control, and Continuous Integration to Build Reproducible Reports',
                        subtitle: 'Improving Product Quality and Developer Accountability',
                useBuilds: true,
        usePrettify: true,
        enableSlideAreas: true,
        enableTouch: true,
                      },

      // Author information
      presenters: [
            {
        name:  'Peter E. DeWitt, Ph.D.<br><a href="mailto:pdewitt@neptuneinc.org">pdewitt@neptuneinc.org</a>' ,
        company: '',
        gplus: '',
        twitter: '',
        www: '',
        github: ''
      },
            ]
    };
  </script>

  <link href="talk_files/ioslides-13.5.1/fonts/fonts.css" rel="stylesheet" />
  <link href="talk_files/ioslides-13.5.1/theme/css/default.css" rel="stylesheet" />
  <link href="talk_files/ioslides-13.5.1/theme/css/phone.css" rel="stylesheet" />
  <script src="talk_files/ioslides-13.5.1/js/modernizr.custom.45394.js"></script>
  <script src="talk_files/ioslides-13.5.1/js/prettify/prettify.js"></script>
  <script src="talk_files/ioslides-13.5.1/js/prettify/lang-r.js"></script>
  <script src="talk_files/ioslides-13.5.1/js/prettify/lang-yaml.js"></script>
  <script src="talk_files/ioslides-13.5.1/js/hammer.js"></script>
  <script src="talk_files/ioslides-13.5.1/js/slide-controller.js"></script>
  <script src="talk_files/ioslides-13.5.1/js/slide-deck.js"></script>

  <style type="text/css">

    b, strong {
      font-weight: bold;
    }

    em {
      font-style: italic;
    }

    slides > slide {
      -webkit-transition: all 0.4s ease-in-out;
      -moz-transition: all 0.4s ease-in-out;
      -o-transition: all 0.4s ease-in-out;
      transition: all 0.4s ease-in-out;
    }

    .auto-fadein {
      -webkit-transition: opacity 0.6s ease-in;
      -webkit-transition-delay: 0.4s;
      -moz-transition: opacity 0.6s ease-in 0.4s;
      -o-transition: opacity 0.6s ease-in 0.4s;
      transition: opacity 0.6s ease-in 0.4s;
      opacity: 0;
    }

  </style>

  <link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body style="opacity: 0">

<slides class="layout-widescreen">

  <slide class="title-slide segue nobackground">
        <!-- The content of this hgroup is replaced programmatically through the slide_config.json. -->
    <hgroup class="auto-fadein">
      <h1 data-config-title><!-- populated from slide_config.json --></h1>
      <h2 data-config-subtitle><!-- populated from slide_config.json --></h2>
      <p data-config-presenter><!-- populated from slide_config.json --></p>
            <p style="margin-top: 6px; margin-left: -2px;">February 2018</p>
          </hgroup>
  </slide>

<slide class="segue dark nobackground level1"><hgroup class = 'auto-fadein'><h2>Preface</h2></hgroup><article  id="preface">

</article></slide><slide class=""><hgroup><h2>Adopt these tools because &#8230;</h2></hgroup><article  id="adopt-these-tools-because-...">

<p>

<img src="me.jpeg" width=200 height=200 style="float:left"> Me: The following tools will facilitate high quality reproducible reports&#8230;

</p>

<br>

<p>

 

</p>

<p><br></p>

<p>

<img src="eyeroll.gif" width=200 height=200 align="top" style="float:left"> Audience: &#8230; I do just fine. I make reproducible reports. This [expletive] just wants to complicate things&#8230;

</p>

</article></slide><slide class=""><hgroup><h2>Okay, fine. How about this?</h2></hgroup><article  id="okay-fine.-how-about-this">

<ul>
<li><p>&quot;Do this, it is good for you.&quot; &#8230; that is as effective as telling my toddler to each vegetables.</p></li>
<li><p>Instead:</p>

<ul>
<li><p>Show that sending a generic R script <strong>is not</strong> going to generate reproducible results.</p></li>
<li><p>Revisit some of the less pleasant experiences in my career and show how R packages, version control, and CI would have prevented these events from ever taking place.</p></li>
</ul></li>
</ul>

<br> <br>

<p style="text-align:right">

<em>&quot;Learn from the mistakes of others.</em> <br> <em>You can&#39;t live long enough to make them all yourself.&quot;</em>

</p>

<p style="text-align:right">

<em>&#8211; Eleanor Roosevelt</em>

</p>

<!-- ....................................................................... -->

</article></slide><slide class="segue dark nobackground level1"><hgroup class = 'auto-fadein'><h2>Do not rely on scripts</h2></hgroup><article  id="do-not-rely-on-scripts">

</article></slide><slide class=""><hgroup><h2>Consider the following</h2></hgroup><article  id="consider-the-following">

<ul>
<li><p>You&#39;ve done an data analysis project. Wrote <code>important-script.R</code>.</p></li>
<li><p>Your colleague will run the script.</p></li>
<li><p>A supervisor, the one who <em>thinks</em> they are a data analyst, will run your script.</p></li>
<li><p>You work is part of a federally funded project and is subject to Freedom Of Information Act (FOIA). Joe Public is a skeptic and is looking for any reason to discredit the work.</p></li>
<li><p>Excrement flows downhill. Where are you on the company organization chart?</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>Example</h2></hgroup><article  id="example">

<div style="width: 100%; display: table;">
<div style="display: table-row">
<div id="leftcol" style="width: 50%; display: table-cell; vertical-align: top;">
<ul>
<li><p>I have copied several of the data sets from the <a href='https://cran.r-project.org/package=nycflights13' title=''>nycflights13</a> package as .csv</p></li>
<li><p>There are five subdirectories to represent five different users.</p></li>
<li><p><code>important-script.R</code>: a simple data load, explore, simple summary and a simple regression model.</p></li>
<li><p>The <code>each-user.sh</code> bash script will evaluate <code>important-script.R</code> in each user directory.</p></li>
<li><p>Let&#39;s review some files on the next slide.</p></li>
</ul></div>

<!-- end id="leftcol" -->

<div id="rightcol" style="display: table-cell; vertical-align: top;">
<iframe src="tree.html">

</iframe></div>

<p><!-- end id="rightcol"--></p></div>

<p><!-- end table-row --></p></div>

</article></slide><slide class=""><hgroup><h2>Example: <code>important-script.R</code></h2></hgroup><article  id="example-important-script.r">

<iframe src="important-script.R.html">

</iframe>

</article></slide><slide class=""><hgroup><h2>Example: <code>each-user.sh</code></h2></hgroup><article  id="example-each-user.sh">

<iframe src="each-user.sh.html">

</iframe>

</article></slide><slide class=""><hgroup><h2>Example: Evaluate <code>important-script.R</code></h2></hgroup><article  id="example-evaluate-important-script.r">

<p><img src="01-example-image-01.png"></p>

<ul>
<li><p>My version and user01 have the same output.</p></li>
<li><p>No other user has the same output!</p></li>
<li><p>Maybe the differences are minor?</p></li>
<li><p>Let&#39;s look at the differences in the outputs.</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>Expected Output</h2></hgroup><article  id="expected-output">

<iframe src="important-script.Rout.html">

</iframe>

</article></slide><slide class=""><hgroup><h2>Diff between Primary and User01</h2></hgroup><article  id="diff-between-primary-and-user01">

<iframe src="vs-user01.html">

</iframe>

</article></slide><slide class=""><hgroup><h2>Diff between Primary and User02</h2></hgroup><article  id="diff-between-primary-and-user02">

<iframe src="vs-user02.html">

</iframe>

</article></slide><slide class=""><hgroup><h2>Diff between Primary and User03</h2></hgroup><article  id="diff-between-primary-and-user03">

<iframe src="vs-user03.html">

</iframe>

</article></slide><slide class=""><hgroup><h2>Diff between Primary and User04</h2></hgroup><article  id="diff-between-primary-and-user04">

<iframe src="vs-user04.html">

</iframe>

</article></slide><slide class=""><hgroup><h2>Diff between Primary and User05</h2></hgroup><article  id="diff-between-primary-and-user05">

<iframe src="vs-user05.html">

</iframe>

</article></slide><slide class=""><hgroup><h2>Why?!?!</h2></hgroup><article  id="why">

<ul>
<li>First, Running the scripts with <code>--vanilla</code> gives the same result</li>
</ul>

<p><img src="everything-is-okay-vanilla.png"></p>

</article></slide><slide class=""><hgroup><h2>Why?!?!</h2></hgroup><article  id="why-1">

<ul>
<li><p>Why are the outputs different for the five users when <code>important-script.R</code> is evaluated?</p></li>
<li><p>Each user has their own <code>.Rprofile</code> (see next slide) in the working directory (or home directory)</p></li>
<li><p>Read <code>help(&quot;Startup&quot;)</code></p></li>
<li><p>Questions for you:</p></li>
<li>Do you know how to run <code>R --vanilla</code>?

<ul>
<li>On Linux? OSX? Windows? Command line? GUI? RStudio Desktop? RStudio Server? NppToR? Emacs Speaks Statistics (ESS)? (neo)Vim? Nvim-R?</li>
</ul></li>
<li><p>Can you reasonably expect others to evaluate the script via <code>R --vanilla</code>?</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>The .Rprofile files</h2></hgroup><article  id="the-.rprofile-files">

<iframe src="rprofiles.html">

</iframe>

</article></slide><slide class=""><hgroup><h2>What if</h2></hgroup><article  id="what-if">

<ul>
<li><p>What if you are user02, user03, user04, or user05 and your supervisor or Joe Public is user01?</p></li>
<li><p>What if one of the data files isn&#39;t included in the email?</p></li>
<li><p>What if someone moves a data file?</p></li>
<li><p>What if a Windows dev forgets that other operating systems are case sensitive?</p></li>
<li><p>What if someone fat fingers the file and changes something, saves the file, and breaks it?</p></li>
<li><p>What if your script requires dplyr 0.7.0 or newer and the end user has version 0.5.0 installed?</p>

<ul>
<li>To this point I had a collaborative project work with dplyr 0.4.3 but fail with 0.5.0.</li>
</ul></li>
</ul>

</article></slide><slide class=""><hgroup><h2>If you are going to use a script</h2></hgroup><article  id="if-you-are-going-to-use-a-script">

<ul>
<li><p>use <code>packageVersion</code> to check for package versions if needed.</p></li>
<li><p>Don&#39;t modify <code>options</code>, if you must do so</p></li>
</ul>

<pre class = 'prettyprint lang-r'>options()$stringsAsFactors
## [1] TRUE
old_opts &lt;- options()

# set net options
options(stringsAsFactors = FALSE)
options()$stringsAsFactors
## [1] FALSE

# do work

# reset options
options(old_opts)
options()$stringsAsFactors
## [1] TRUE</pre>

</article></slide><slide class=""><hgroup><h2>If you are going to use a script</h2></hgroup><article  id="if-you-are-going-to-use-a-script-1">

<ul>
<li>Explicity use namespaces, e.g.,</li>
</ul>

<pre class = 'prettyprint lang-r'># good
mtcars %&gt;% dplyr::filter(.data$mpg &gt; 30)

# bad
mtcars %&gt;% filter(mpg &gt; 30)</pre>

<ul>
<li>From <code>vignette(&quot;programming&quot;, package = &quot;dplyr&quot;)</code>: dplyr code is ambiguous. Depending on what variables are defined where, filter(df, x == y) could be equivalent to any of:</li>
</ul>

<pre class = 'prettyprint lang-r'>df[df$x == df$y, ]
df[df$x == y, ]
df[x == df$y, ]
df[x == y, ]</pre>

<ul>
<li>Do you know what will be in another user&#39;s workspace?</li>
</ul>

</article></slide><slide class="segue dark nobackground level1"><hgroup class = 'auto-fadein'><h2>The Simplest R Package</h2></hgroup><article  id="the-simplest-r-package">

<p style="text-align:right">

<em>&quot;We love the R build process.<br> It is robust, cross-platform, reliable,<br>and rather predictable. <br> It. Just. Works.&quot;</em>

</p>

<p style="text-align:right">

<em>&#8211; Dirk Eddelbuettel</em>

</p>

</article></slide><slide class=""><hgroup><h2>An R Package for just <code>important-script.R</code></h2></hgroup><article  id="an-r-package-for-just-important-script.r">

<div style="width: 100%; display: table;">
<div style="display: table-row">
<div id="leftcol" style="width: 30%; display: table-cell; vertical-align: top;">
<iframe src="ispkg-tree.html">

</iframe></div>

<!-- end id="leftcol" -->

<div id="rightcol" style="display: table-cell; vertical-align: top;">
<p>DESCRIPTION <br> <iframe src="ispkg-DESCRIPTION.html" style="height:200px"></iframe> <br> vignettes/important-script.Rmd <br> <iframe src="ispkg-important-script.Rmd.html" style="height:240px"></iframe></p></div>

<p><!-- end id="rightcol"--></p></div>

<p><!-- end table-row --></p></div>

</article></slide><slide class=""><hgroup><h2>Build and Check</h2></hgroup><article  id="build-and-check">

<p><img src="ispkg-r-cmd-build.png"></p>

<p><code>R CMD check</code> <iframe src="ispkg-checklog.html" style="height:240px"></iframe></p>

</article></slide><slide class=""><hgroup><h2>Other Users</h2></hgroup><article  id="other-users">

<iframe src="each-user-pkgbuild.sh.html" style="height:240px">

</iframe>

<p><img src="each-user-pkgbuild-md5.png"></p>

<p>The MD5 sums are different because the <code>DESCRIPTION</code> files are different.</p>

</article></slide><slide class=""><hgroup><h2>Other Users</h2></hgroup><article  id="other-users-1">

<iframe src="ispkg-md5-diff.html" style="height:240px">

</iframe>

<iframe src="ispkg-built-description.html" style="height:240px">

</iframe>

<p>Time stamp for when the package was built is different from build to build.</p>

</article></slide><slide class=""><hgroup><h2>The Vignette</h2></hgroup><article  id="the-vignette">

<iframe src="ispkg-vignette.html">

</iframe>

</article></slide><slide class=""><hgroup><h2>Moving from important-script.R to a R Package</h2></hgroup><article  id="moving-from-important-script.r-to-a-r-package">

<ul>
<li><p>At a minimum:</p>

<ul>
<li><p><code>important-script.R</code> → <code>vignettes/important-script.Rmd</code></p></li>
<li><p>Note needed packages in the Suggests section of the <code>DESCRIPTION</code> file.</p></li>
</ul></li>
<li><p>Additional:</p>

<ul>
<li>helper functions written in the R directory</li>
<li>tests</li>
<li>examples</li>
<li>&#8230;</li>
</ul></li>
</ul>

</article></slide><slide class=""><hgroup><h2>R Package is better because&#8230;</h2></hgroup><article  id="r-package-is-better-because...">

<ul>
<li><p>The source file (<code>.tar.gz</code>) is the standard (best) method for sending code and results.</p></li>
<li><p>All users were able to build the same package with the same command.</p></li>
<li><p>The <code>&lt;pkgname&gt;_&lt;version&gt;.tar.gz</code> is the target reproducible result.</p></li>
<li><p>When building with <code>--md5</code> you provide a tool to let others know that they have received the correct file, and/or (re)built the package correctly.</p></li>
<li><p>Re-evaluating the vignette, after installing the package:</p>

<ul>
<li><p><code>system.file</code> eliminates (most) issues with end user moving files.</p></li>
<li><p>In an interactive session, the <code>.Rprofile</code> or other workspace issues can/will affect the results.</p></li>
</ul></li>
</ul>

</article></slide><slide class="segue dark nobackground level1"><hgroup class = 'auto-fadein'><h2>Why version control</h2></hgroup><article  id="why-version-control">

<p>Version control shows who made changes and when those changes were made.</p>

</article></slide><slide class=""><hgroup><h2>Why use version control?</h2></hgroup><article  id="why-use-version-control">

<p style="font-size:60px">

<code>git log</code> <br> <code>svn log</code>

</p>

<p>and</p>

<p style="font-size:60px">

<code>git blame</code> <br> <code>svn blame</code>

</p>

</article></slide><slide class=""><hgroup><h2>The story</h2></hgroup><article  id="the-story">

<p>This is a simple, day-to-day working experience. Nothing bad, but a good example for why version control is important.</p>

<ul>
<li><p>Colleague 1: Hey, Peter, do you have a minute?</p></li>
<li><p>Me: Yeah, what can I help you with?</p></li>
<li><p>Colleague 1: I&#39;m looking over the report you wrote (five months ago) and the value reported is 1.67 but when I source your code I get 1.92.</p></li>
<li><p>Me: That&#39;s not good. Let me see what you&#39;re looking at.</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>The Issue</h2></hgroup><article  id="the-issue">

<ul>
<li><p>The value in question was a default value used to reproduce and extend the work of a published paper.</p></li>
<li><p>I had structured my work as an R package. Vignettes for the documentation and writing an analysis script.</p></li>
<li><p>The report, however, was a standalone document.</p>

<ul>
<li>Report: 1.67</li>
<li><code>source(&quot;R/published.R&quot;)</code>: 1.92</li>
</ul></li>
<li><p>The project that I was contributing to was housed in a subversion repository.</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>Check the log</h2></hgroup><article  id="check-the-log">

<p>(Names of files, people, and specific details have been modified)</p>

<p>The value in question was defined in the package file <code>R/published.R</code></p>

<pre >dewittpe@PrecisionM4500 [~/work/AGD/analysis/rpkg/]
$ svn log R/published.R

------------------------------------------------------------------------
r1255 | ctwo | 2017-09-11 20:37:29 -0600 (Mon, 11 Sep 2017) | 2 lines

Colleague 2 edits to code:

------------------------------------------------------------------------
r1241 | pdewitt | 2017-08-23 13:08:06 -0600 (Wed, 23 Aug 2017) | 1 line

added source code for R package used for [specific outcome] development.
------------------------------------------------------------------------</pre>

</article></slide><slide class=""><hgroup><h2>Look at the blame</h2></hgroup><article  id="look-at-the-blame">

<pre >dewittpe@PrecisionM4500 [~/work/AGD/analysis/rpkg/]
$ svn blame R/published.R
   1241    pdewitt #&#39; Default Values for [Published Results]
   1241    pdewitt #&#39;
   1241    pdewitt #&#39; @return A list with the gamma and sigma gamma values.
   1241    pdewitt #&#39;
   1241    pdewitt #&#39; @seealso \code{vignette(&quot;distributions&quot;, package = &quot;rpkg&quot;)}
   1241    pdewitt #&#39;
   1241    pdewitt published_defaults &lt;- function() {
   1255       ctwo   betas   &lt;- c(0.0296, 1.92, 0.23, 1.83)
   1255       ctwo   betacis &lt;- matrix(c(0.0113, 1.30, 0.026, 0.30, 0.0272, 2.61, 3.95, 2.37), ncol = 2)
   1241    pdewitt
   1241    pdewitt   gammas              &lt;- betas
   1241    pdewitt   gammas[c(1, 3)]     &lt;- log10(betas[c(1, 3)])
   1241    pdewitt   gammacis            &lt;- betacis
   1241    pdewitt   gammacis[c(1, 3), ] &lt;- log10(betacis[c(1, 3), ])
   1241    pdewitt
   1255       ctwo   sigmagammas &lt;- (gammas - gammacis[, 1]) / stats::qnorm(0.975) #okay if symmetric
   1241    pdewitt
   1241    pdewitt   list(gammas = gammas, sigma_gammas = sigmagammas)
   1241    pdewitt }</pre>

</article></slide><slide class=""><hgroup><h2>Look at the diff</h2></hgroup><article  id="look-at-the-diff">

<pre >dewittpe@PrecisionM4500 [~/work/AGD/analysis/rpkg/]
$ svn diff -r 1241 R/published.R@1255
Index: R/published.R
===================================================================
--- R/published.R  (revision 1241)
+++ R/published.R  (working copy)
@@ -8,8 +8,8 @@
 published_defaults &lt;- function() {
-  betas   &lt;- c(0.0169, 1.67, 0.32, 1.83)
-  betacis &lt;- matrix(c(0.0108, 1.35, 0.026, 0.30, 0.0264, 2.61, 3.95, 2.37), ncol = 2)
+  betas   &lt;- c(0.0296, 1.92, 0.32, 1.83)
+  betacis &lt;- matrix(c(0.0113, 1.30, 0.026, 0.30, 0.0272, 2.61, 3.95, 2.37), ncol = 2)

-  sigmagammas &lt;- (gammas - gammacis[, 1]) / stats::qnorm(0.975)
+  sigmagammas &lt;- (gammas - gammacis[, 1]) / stats::qnorm(0.975) #okay if symmetric

   list(gammas = gammas, sigma_gammas = sigmagammas)
 }</pre>

</article></slide><slide class=""><hgroup><h2>(Step Back to R Packages)</h2></hgroup><article  id="step-back-to-r-packages">

<ul>
<li><p>Updated code, but the report document was not updated.</p></li>
<li><p>Primary report was not a vignette.</p>

<ul>
<li>If it had been, the possibility of the discrepancy between code and report would have been mitigated.</li>
</ul></li>
</ul>

</article></slide><slide class=""><hgroup><h2>Version Control</h2></hgroup><article  id="version-control">

<ul>
<li><p>Issue: reported value was different from the value someone would get if running the code.</p></li>
<li><p>Initial person responsible for resolving issue: Me, author of report and code.</p></li>
<li><p>Person responsible for discrepancy: Colleague 2</p>

<ul>
<li>This is only known thanks to version control.</li>
</ul></li>
<li><p>What if there was no VC?</p>

<ul>
<li><p>Say the code was shared via email, stored on a network drive? Dropbox? Google Docs? (The latter two have some form of VC but subversion or git would be preferable.)</p></li>
<li><p>Who would held responsible for resolving the issue?</p></li>
</ul></li>
</ul>

</article></slide><slide class="segue dark nobackground level1"><hgroup class = 'auto-fadein'><h2>resource-functions.R</h2></hgroup><article  id="resource-functions.r">

<p>This story provides an example for why we should use R packages and VC and CI.</p>

<p>R packages can improve documentation. <code>R CMD check</code> will verify some basics for documentation, such as function parameters, and that examples evaluate without error.</p>

<p>VC: show who made changes and when those changes were made.</p>

<p>CI: Automatic builds to testing</p>

</article></slide><slide class=""><hgroup><h2>The Story</h2></hgroup><article  id="the-story-1">

<p>Supervisor is primary author and primary analyst for a research project. By decree:</p>

<ol>
<li><p>All development will be in R scripts. No packages.</p>

<ul>
<li><p>Supervisor has never built an R package.</p></li>
<li><p>Standard &quot;I don&#39;t have time to learn that&quot; excuse for not using a package.</p></li>
</ul></li>
<li><p>Collaboration via git.</p></li>
<li><p>Manuscript authored via .Rmd.</p></li>
</ol>

</article></slide><slide class=""><hgroup><h2>The Story, continued&#8230;</h2></hgroup><article  id="the-story-continued...">

<p>I am tasked with building a <code>resource-functions.R</code> script that will provide tools for performing the data analysis.</p>

<p>This script must provide functions which are generic enough to work with three different data sets, each set with multiple responses and unique sets of explanatory variables. Support cross validation, two different regression methods, implement model selection searches with a dynamic, user specified, model selection criterion.</p>

<p>Each call to the primary function will report multiple summary tables, which need to be customizable, and several model searching results/diagnostics, and the results from the selected models.</p>

<p>The <code>resource-functions.R</code> script must be fully documented, including examples.</p>

</article></slide><slide class=""><hgroup><h2>The Story, continued&#8230;</h2></hgroup><article  id="the-story-continued...-1">

<p>I know that there is a <code>setup.R</code> script that is called when the analysis/manuscript with the form:</p>

<pre class = 'prettyprint lang-r'>source(&#39;Rscripts/load-data.R&#39;)
source(&#39;Rscripts/clean-data.R&#39;)
source(&#39;Rscripts/resource-functions.R&#39;)
source(&#39;Rscripts/analysis.R&#39;)

library(rmarkdown)
render(&quot;manuscript.Rmd&quot;)</pre>

<p>Because <code>resource-functions.R</code> is being sourced I know that the examples <em>must</em> be commented out. The functions provide tools for cross validation. Running the examples every time the file is sourced, which occurs dozens of times a day, will require to much computation time and will be unacceptable.</p>

</article></slide><slide class=""><hgroup><h2>The Story, continued&#8230;</h2></hgroup><article  id="the-story-continued...-2">

<!--
I make the choice to not use roxygen style documentation.  Such documentation
would be extremely helpful for package development, but, as only a script is
permissible, and supervisor has no experience with roxygen I choose not to use
that syntax.

While it would improve this story, I don't believe it would be proper to show the
file.
-->

<p>I committed and pushed the <code>resource-functions.R</code> script to the project repository.</p>

<p>A few days latter&#8230;</p>

</article></slide><slide class=""><hgroup><h2>A pair of emails</h2></hgroup><article  id="a-pair-of-emails">

<p style="font-size:80%">

Peter- <br> <code>resource-functions.R</code> is too dense, and it is impeding my workflow. The comments are not helpful or consistently accurate. &#8230; I just tried to run [workhorse function] according to the comment immediately above it, and it won&#39;t run. It&#39;s ridiculous that extracting alphas is buried that deep. &#8230; <br> <br> Write simpler, longer code. Break things into pieces. Do not nest functions for any project with me. We are not writing software, we are doing research. <br> <br> If you can&#39;t do this, I need to know. <br> <br> -[Supervisor]

</p>

<p><strong>Two hours later:</strong></p>

<p style="font-size:80%">

Peter- <br> The email earlier this afternoon should not have been sent, I apologize. I was frustrated and broke one of my own rules about electronic communication. We can discuss further in person. <br> Thanks, <br> -[Supervisor]

</p>

</article></slide><slide class=""><hgroup><h2>Four Notes:</h2></hgroup><article  id="four-notes">

<ul>
<li><p>&quot;If you can&#39;t do this, I need to know.&quot;</p>

<ul>
<li>Translation: Do me a favor and resign so I don&#39;t have to fire you.</li>
</ul></li>
<li><p>&quot;We are not writing software, we are doing research.&quot;</p>

<ul>
<li><p>Software definition from Dictionary.com: &quot;the programs used to direct the operation of a computer, as well as documentation giving instructions on how to use them.&quot;</p></li>
<li><p>We are writing software. An R script is a set of instructions for the computer to turn data into a report.</p></li>
</ul></li>
<li><p>&quot;Write simpler, longer code. Break things into pieces. Do not nest functions for any project with me.&quot;</p>

<ul>
<li>These are contradictory instructions.</li>
</ul></li>
</ul>

</article></slide><slide class=""><hgroup><h2>Four Notes:</h2></hgroup><article  id="four-notes-1">

<ul>
<li><p>&quot;The comments are not helpful or consistently accurate. &#8230; I just tried to run [workhorse function] according to the comment immediately above it, and it won&#39;t run.&quot;</p>

<ul>
<li>The example not running was the impetus for the email. All the other stuff was spill over form the frustration pot boiling over.</li>
</ul></li>
<li><p><strong>There are automated tests for all of these issues built into the <code>R CMD   build</code> and the <code>R CMD check</code>.</strong></p></li>
<li><p>This email, and the issues spurring the email, could have been prevent.</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>What Happened?</h2></hgroup><article  id="what-happened">

<ul>
<li><p><code>git log</code> found the commit (sha abf342d) for my initial submission of the <code>resource-functions.R</code> script.</p></li>
<li><p><code>git checkout abf342d</code> and showed that</p>

<ul>
<li>The examples run.</li>
</ul></li>
<li><p><code>git checkout master</code></p>

<ul>
<li><p>The examples fail.</p></li>
<li><p>The &quot;not accurate&quot; documentation was partially due some functional arguments missing documentation and default values not matching between documentation and the function call.</p></li>
</ul></li>
</ul>

</article></slide><slide class=""><hgroup><h2>What Happened?</h2></hgroup><article  id="what-happened-1">

<ul>
<li><p><code>git blame</code></p>

<ol>
<li><p>[Supervisor] had changed the default value for a function&#39;s arguments without updating the documentation.</p></li>
<li><p>[Supervisor] An edit to the body of a function resulted in the example failing. No edits to the example had been made.</p></li>
</ol></li>
</ul>

</article></slide><slide class=""><hgroup><h2>Other Issues</h2></hgroup><article  id="other-issues">

<ul>
<li><p>Running <code>setup.R</code> in an interactive session.</p>

<ul>
<li>My build process was to always run <code>setup.R</code> from a clean R session.</li>
</ul></li>
<li><p>Several times I would <code>fetch</code> changes that would not run.</p>

<ul>
<li><p>development work pollutes your workspace.</p></li>
<li><p>Code might work in your current interactive session but not in a new session.</p></li>
</ul></li>
</ul>

<pre class = 'prettyprint lang-r'># What happens when these two lines are evaluated twice in one session?
x + 2
x &lt;- 2</pre>

</article></slide><slide class=""><hgroup><h2>Quick Updates</h2></hgroup><article  id="quick-updates">

<ul>
<li><p>Tense, but constructive, discussion in person.</p></li>
<li><p>Extended documentation further.</p>

<ul>
<li><p>Built several stand alone scripts for examples.</p></li>
<li><p><strong>This still required manual checking of the examples when resource-functions.R was updated.</strong></p></li>
</ul></li>
<li><p>This particular project did yield three publications, including a top tier journal.</p></li>
<li><p>[Supervisor] along with my former department chair tried valiantly to hire me as lead data scientist for a new group they were co-heads of.</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>R Package, VC, and CI would have helped?</h2></hgroup><article  id="r-package-vc-and-ci-would-have-helped">

<ul>
<li><p>Already showed why VC was important:</p></li>
<li><p>Why An R Package:</p>

<ul>
<li><p><code>R CMD build</code> and <code>R CMD check</code> to build the package, check that the documentation is consistent (as least in structure) and that the examples run (at least they don&#39;t error)</p></li>
<li><p>Use <a href='https://cran.r-project.org/package=testthat' title=''>testthat</a> to build custom tests to run during <code>R CMD check</code>.</p></li>
</ul></li>
</ul>

</article></slide><slide class=""><hgroup><h2>R Package, VC, and CI would have helped?</h2></hgroup><article  id="r-package-vc-and-ci-would-have-helped-1">

<ul>
<li><p>Why is CI important:</p>

<ul>
<li><p>The automated build process would have shown that my initial commit</p>

<ul>
<li>built,</li>
<li>examples would run to completion, and</li>
<li>passed any specified tests.</li>
</ul></li>
<li><p>Automated tests will catch errors when</p>

<ul>
<li><p>the dev fails to run local tests, or,</p></li>
<li><p>when local tests pass due to a local setting, but fail in a clean environment.</p></li>
</ul></li>
<li><p>The CI application can notify the developer that their code fails.</p></li>
</ul></li>
</ul>

</article></slide><slide class=""><hgroup><h2>A Simple Example: Build and Check a Package</h2></hgroup><article  id="a-simple-example-build-and-check-a-package">

<ul>
<li><p>Start with a package with one function: <code>bmi</code></p></li>
<li><p>This package will be extended to illustrate solutions to two other professional experiences.</p></li>
<li><p>Skeleton for the package via <code>devtools::create()</code></p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>The Example Package</h2></hgroup><article  id="the-example-package">

<div style="width: 100%; display: table;">
<div style="display: table-row">
<div id="leftcol" style="width: 30%; display: table-cell; vertical-align: top;">
<p>Directory Tree <iframe src="egpkg-html/tree-00.html" style="height:200px"></iframe></p></div>

<!-- end id="leftcol" -->

<div id="rightcol" style="display: table-cell; vertical-align: top;">
<p>DESCRIPTION <iframe src="egpkg-html/DESCRIPTION-00.html" style="height:150px"></iframe></p>

<p>R/bmi.R <iframe src="egpkg-html/bmi.R-00.html" style="height:275px"></iframe></p></div>

<p><!-- end id="rightcol"--></p></div>

<p><!-- end table-row --></p></div>

</article></slide><slide class=""><hgroup><h2>The Example Package: document, build, check</h2></hgroup><article  id="the-example-package-document-build-check">

<ul>
<li>roxygen comments used to generate the man file via <code>devtools::document()</code></li>
<li>Build via <code>R CMD build</code> or <code>devtools::build()</code></li>
<li>Check via <code>R CMD check</code> or <code>devtools::check()</code></li>
</ul>

<iframe src="egpkg-html/check-00.html" style="height:350px">

</iframe>

</article></slide><slide class=""><hgroup><h2>The Example Package: Edit the bmi function</h2></hgroup><article  id="the-example-package-edit-the-bmi-function">

<iframe src="egpkg-html/bmi.R-01.html" style="height:350px">

</iframe>

<ul>
<li><p>Assume that this is the only edit made.</p></li>
<li><p><code>R CMD build</code> will work</p></li>
<li><p>Results from <code>R CMD check</code> are:</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>The Example Package: check after bmi edit</h2></hgroup><article  id="the-example-package-check-after-bmi-edit">

<ul>
<li>Man files were not updated. (A warning)</li>
<li>The example fails! (An error)</li>
</ul>

<iframe src="egpkg-html/check-01.html" style="height:350px">

</iframe>

<ul>
<li>If there was CI, then these errors would be reported to the developer.</li>
</ul>

</article></slide><slide class=""><hgroup><h2>The Example Package: Update the bmi documentation</h2></hgroup><article  id="the-example-package-update-the-bmi-documentation">

<ul>
<li>Edits to documentation <iframe src="egpkg-html/bmi.R-02.html" style="height:200px"></iframe></li>
<li><code>devtools::document()</code></li>
<li><code>R CMD build</code></li>
<li><code>R CMD check</code></li>
</ul>

<pre >Status: OK</pre>

</article></slide><slide class=""><hgroup><h2>The Example Package: Update the bmi documentation</h2></hgroup><article  id="the-example-package-update-the-bmi-documentation-1">

<iframe src="egpkg-html/bmi-man-02.html" style="height:400px">

</iframe>

</article></slide><slide class="segue dark nobackground level1"><hgroup class = 'auto-fadein'><h2>Testing</h2></hgroup><article  id="testing">

</article></slide><slide class=""><hgroup><h2>The Story</h2></hgroup><article  id="the-story-2">

<p>This story took place about ten years ago. I am working as a Siebel CRM software developer.</p>

<p>One thing I built was the client vital statistics input page.</p>

<ul>
<li>Requirements:

<ul>
<li>Client height to be entered in inches</li>
<li>Client weight to be entered in pounds</li>
<li>Page will automatically report BMI</li>
</ul></li>
<li>Several months later a tester was given this script:</li>
</ul>

<p>&quot;Verify that a six foot one inch tall, three hundred pound client has a BMI of 39.6&quot;</p>

<ul>
<li>and then&#8230;.</li>
</ul>

</article></slide><slide class=""><hgroup><h2>The Story</h2></hgroup><article  id="the-story-3">

<ul>
<li><p>I&#39;m sitting in the developer bullpen. Tester comes running down form the testing office and had some choice words for me; delivered loudly and publicly.</p></li>
<li><p>Translation: I&#39;m so incompetent that I can write a function to calculate BMI.</p></li>
</ul>

<pre class = 'prettyprint lang-r'>bmi &lt;- function(height, weight) {
  weight / height ** 2 * 703
}

# Expected input and output
bmi(73, 300)
## [1] 39.57591

# Tester&#39;s input and output
# (tester had little experience with non-metric units of measure)
bmi(6.1, 300)
## [1] 5667.831</pre>

</article></slide><slide class=""><hgroup><h2>Issues</h2></hgroup><article  id="issues">

<ul>
<li><p>The software requirements where met.</p></li>
<li><p>Software requirements might not have been sufficient.</p>

<ul>
<li>Setting up tests for acceptable height ranges were added</li>
</ul></li>
<li><p>Despite the web page interface labeling the input box with &quot;inches&quot; and &quot;lbs&quot; humans don&#39;t always read everything.</p></li>
<li><p>The tester was testing TWO things</p>

<ol>
<li>When inputting 73 for height and 300 for weigth, does the function return a value of 39.6?</li>
<li>Is the human inputting the data capable of translating between feet-and-inches to just inches?</li>
</ol></li>
<li>We can automate 1.</li>
<li><p>We can&#39;t account for all PEBKAC errors.</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>Use <a href='https://cran.r-project.org/package=testthat' title=''>testthat</a></h2></hgroup><article  id="use-testthat">

<ul>
<li>Use <code>devtools::use_testthat()</code> to set up the directory structure.</li>
</ul>

<div style="width: 100%; display: table;">
<div style="display: table-row">
<div id="leftcol" style="width: 40%; display: table-cell; vertical-align: top;">
<iframe src="egpkg-html/tree-testthat.html" style="height:300px">

</iframe></div>

<!-- end id="leftcol" -->

<div id="rightcol" style="display: table-cell; vertical-align: top;">
<p><code>test_bmi.R</code> <iframe src="egpkg-html/test_bmi.R.html" style="height:100px"></iframe> Check <iframe src="egpkg-html/testthat-check-00.html" style="height:300px"></iframe></p></div>

<p><!-- end id="rightcol"--></p></div>

<p><!-- end table-row --></p></div>

</article></slide><slide class="segue dark nobackground level1"><hgroup class = 'auto-fadein'><h2>CI: Automated Builds and Testing</h2></hgroup><article  id="ci-automated-builds-and-testing">

</article></slide><slide class=""><hgroup><h2>Why use CI</h2></hgroup><article  id="why-use-ci">

<ul>
<li><p>Perhaps not all team members are diligent with respect to running local tests.</p></li>
<li><p>CI provides implicit documentation on the system dependencies for a project.</p></li>
<li><p>Customizable</p></li>
<li><p>gitlab: <a href='https://docs.gitlab.com/ce/ci/yaml/README.html' title=''>https://docs.gitlab.com/ce/ci/yaml/README.html</a></p></li>
<li><p>github: see travis-ci <a href='https://docs.travis-ci.com/' title=''>https://docs.travis-ci.com/</a></p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>The Story</h2></hgroup><article  id="the-story-4">

<p>This is a story that may not match up well with R package development, at least I hope not, but I hope it shows why version control, testing, and CI are critically important.</p>

<ul>
<li><p>During my time as a Siebel developer.</p></li>
<li><p>Monday morning: Arrive at the client site. Informed that there is a critical feature that must be built and pushed to production before start of business Tuesday.</p></li>
<li><p>I&#39;m not the only dev with critical feature development to do.</p></li>
<li><p>Supervisor drops by and asks for a &quot;nice-to-have&quot; feature. I tell him &quot;No, not now. I need to take for this critical feature. That&#39;s a nice-to-have, I&#39;ll look at it Wednesday.&quot; Supervisor walks away.</p></li>
<li><p>I build the critical feature.</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>The Story &#8230;</h2></hgroup><article  id="the-story-...">

<p><strong>There will be no system test. Local test only. System test will be done in production.</strong></p>

<ul>
<li><p>I gather my immediate supervisor, the development lead, the project manager, and general manager to witness my local tests and verify the system is working.</p></li>
<li><p>I push my changes to production per management (&quot;I was just following orders&quot;)</p></li>
<li><p>Other devs push their changes.</p></li>
<li><p><strong>System goes down</strong> The customer management system for the entire nation goes down.</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>The Story &#8230;</h2></hgroup><article  id="the-story-...-1">

<ul>
<li><p>Developers and testers work to find the offending code. It was found in the Inventory Business Object &#8211; My subsystem.</p></li>
<li><p>I&#39;m now tasked with fixing this error.</p></li>
<li><p>Problem: the nice-to-have feature my supervisor wanted was in production. It had a critical error that caused the system to fail. I didn&#39;t build it. My supervisor built it and pushed to production after okaying the work I had done.</p></li>
<li><p>There was no meaningful version control. No way to show who had made the error, nor to revert the system.</p>

<ul>
<li>Daily snapshots were available for catastrophic errors.</li>
</ul></li>
<li><p>I fixed the errors and the nice-to-have feature persisted.</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>The Story &#8230;</h2></hgroup><article  id="the-story-...-2">

<ul>
<li><p>There was no system test.</p></li>
<li><p>There was no CI/build test: such a test could have prevented the change from going into production.</p></li>
<li><p>I was held responsible for someone else&#39;s error.</p></li>
<li><p>This event was cited as the primary reason for not being promoted during my annual review two months later.</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>Adding CI to Your Project</h2></hgroup><article  id="adding-ci-to-your-project">

<ul>
<li><p>github.com:</p>

<ul>
<li>link your public repo to travis-ci.org (.com for private)</li>
<li>add a <code>.travis.yaml</code> file to the root of your project working directory.</li>
</ul></li>
<li><p>gitlab:</p>

<ul>
<li>add a <code>.gitlab-ci.yml</code> file to the root of your repository</li>
</ul></li>
</ul>

</article></slide><slide class=""><hgroup><h2>Adding CI to Your Project</h2></hgroup><article  id="adding-ci-to-your-project-1">

<ul>
<li><p>github: look at travisci and use <code>devtools::use_travis()</code></p>

<ul>
<li>Read <a href='http://r-pkgs.had.co.nz/check.html#travis' title=''>http://r-pkgs.had.co.nz/check.html#travis</a></li>
</ul></li>
</ul>

<iframe src="egpkg-html/travis.yml.html" style="height:300px">

</iframe>

</article></slide><slide class=""><hgroup><h2>Adding CI to Your Package:</h2></hgroup><article  id="adding-ci-to-your-package">

<ul>
<li>gitlab: has docker and several tools set up for pipelines.</li>
</ul>

<iframe src="egpkg-html/gitlab-ci.yml.html" style="height:450px">

</iframe>

</article></slide><slide class="segue dark nobackground level1"><hgroup class = 'auto-fadein'><h2>Final Notes</h2></hgroup><article  id="final-notes">

</article></slide><slide class=""><hgroup><h2>Suggestions</h2></hgroup><article  id="suggestions">

<ol>
<li><p>Use VC, even it is just you.</p>

<ul>
<li>Can be completely local or used in tandem with repository hosts.</li>
<li>Check EOA for and be careful about where you keep your data.</li>
</ul></li>
<li><p>Control who can contribute changes with or without human interaction:</p>

<ul>
<li><p>Git: Limit the number of people who have push access to the master branch. Fork and merge requests for/from others.</p></li>
<li><p>SVN: you are the trunk maintainer, have contributions via reintegrating branches or having patches sent from others.</p></li>
</ul></li>
<li><p>Use CI. Customizable for any project.</p></li>
</ol>

<p><strong>These suggestions are for any project. Not just R packages.</strong></p>

</article></slide><slide class=""><hgroup><h2>Suggestions</h2></hgroup><article  id="suggestions-1">

<ul>
<li><p>Simple analysis, major research project, or even a thesis/dissertation: Build R packages!</p>

<ul>
<li><p>Data packages: great way to curate collected and/or generated data.</p></li>
<li><p>It is okay to build multiple packages.</p></li>
<li><p>It is okay to break one package into multiple packages.</p></li>
</ul></li>
<li><p>Use makefiles. The build process can be customized. To insure that all developers, regardless of IDE and OS, have the same build process, use (a) makefile(s).</p></li>
<li><p>Window users will need Cygwin and/or Rtools installed.</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>Things are changing</h2></hgroup><article  id="things-are-changing">

<ul>
<li><p>Aim 3 of my PhD dissertation was method dissemination.</p>

<ul>
<li><p>Wrote and publish two R packages.</p></li>
<li><p>Thought: Too easy, I know how to do this, was going to do it anyways just to support Aims 1 and 2.</p></li>
<li><p>Advisor: John Hopkins biostats is requiring all PhD students to write and publish their methods via R packages, or similar archetype.</p></li>
</ul></li>
<li><p>Side note: a competing method for my Aim 1 was not evaluated.</p>

<ul>
<li>Method was published but no software released to support manuscript.</li>
<li><p>Recieved <code>method.R</code> script from authors</p>

<ul>
<li>Script failed, system specific file paths, depended scripts that had long been lost. Package version issues that were not documented, &#8230;</li>
</ul></li>
</ul></li>
</ul>

</article></slide><slide class=""><hgroup><h2>Things are changing</h2></hgroup><article  id="things-are-changing-1">

<ul>
<li><p>Observations form UCD</p>

<ul>
<li><p>2010-2011 academic year:</p>

<ul>
<li><p>I, one other student, and one faculty member used Sweave (knitr initial release was January 2012). All incoming students had either SAS experience or no statistical software experience.</p></li>
<li><p>SAS was primary language used in course work.</p></li>
</ul></li>
<li><p>2016-2017: Majority of the incoming master students (also youngest incoming class) had R experience, and were using knitr</p>

<ul>
<li>Some courses <strong>require</strong> assignments to be authored in .Rmd files, use git, and R.</li>
</ul></li>
</ul></li>
<li><p>Are you staying up to date with the next generation of graduate students?</p></li>
</ul>

</article></slide><slide class=""><hgroup><h2>Thanks</h2></hgroup><article  id="thanks">

<ul>
<li><p>Must read resources:</p>

<ul>
<li>&quot;R Packages&quot; by Hadley Wickham, <a href='http://r-pkgs.had.co.nz/r.html' title=''>http://r-pkgs.had.co.nz/r.html</a></li>
<li>&quot;Advanced R&quot; by Hadley Wickham, <a href='http://adv-r.had.co.nz/' title=''>http://adv-r.had.co.nz/</a></li>
</ul></li>
<li>Must have tools:

<ul>
<li>devtools, testthat</li>
</ul></li>
<li><p>I&#39;m working on a wrapper, <code>qwraps2::create_pkg</code> which uses <code>devtools::create</code> to build a package skeleton with more of the default files and structure I prefer.</p>

<ul>
<li>Development version on <a href='https://github.com/dewittpe/qwraps2' title=''>https://github.com/dewittpe/qwraps2</a></li>
</ul></li>
</ul>

</article></slide><slide class=""><hgroup><h2></h2></hgroup><article  id="section">

<p><img src="THAT'SALLGIFS.gif"></p></article></slide>


  <slide class="backdrop"></slide>

</slides>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!-- map slide visiblity events into shiny -->
<script>
  (function() {
    if (window.jQuery) {
       window.jQuery(document).on('slideleave', function(e) {
         window.jQuery(e.target).trigger('hidden');
      });
       window.jQuery(document).on('slideenter', function(e) {
         window.jQuery(e.target).trigger('shown');
      });
    }
  })();
</script>

</body>
</html>
